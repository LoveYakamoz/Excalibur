'''
版本：面向对象重构 二八择时小市值v2.0.7
日期：2017.1.4
原作者：Morningstar
修改者：晚起的小虫
'''
'''
2017-02-23更新:
    1. 新增通过实盘易自动申购新股的规则类 Purchase_new_stocks
    2. 更改回调用实盘易官方SDK的shipane_sdk.py的方法。方便日后更新。

2017-02-21更新:
    1. 把原SDK的JoinQuantExecutor类整合到Shipane_order规则里。
        使用Rule的几种log方法，避免原先的_logger带来的无法序列化错误。
    2. 把原SDK的Client更改为继承Rule，并删除_logger。
        使用Rule的几种log方法，避免原先的_logger带来的无法序列化错误。
    3. Shipane_order 下单时加Try，以避免下单错误时导致模拟盘异常退出。
        这里只是简单粗暴的处理下单失败，其实可以更进一步避免失败(未 )。
        1) 下卖单时，通过获取持仓信息，来判断有多少可卖的，是否达到order要求
        2) 下买单时，通过获取持仓信息，来判断下的买单数量是否达到order要求，是否需要拆单
            这里可参考Shipane_sync_p的一些处理方式。

2017-02-16更新:
    1. 修正模拟盘更新代码的潜藏BUG。原机制，假如一个规则创建两个实例，就会更新规则错乱。
    规则配置 [True,'_filter_gem_','过滤创业板',Filter_gem,{}],第二 个字段为定义一个对象名。
    如果一个规则只用了一次，可以不写。假如同一个规则使用多次，则需要一定要写名字。
    例如 创建两个实盘易规则，去操作两个通达信帐号。
    2. 修正Filter_rank 传入Stock_list为空时异常的Bug。
    3. Shipane_sync_p 在执行完买卖单后sleep一定时间，避免操作太快，持仓信息没更新
2017-02-15更新:
    1. 更改原Shipane类名为 Shipane_sync_p
    2. Shipane_sync_p新增清仓时执行同步持仓。
    3. 新增按聚宽下单的order用实盘易跟单实盘下单规则类 Shepane_order。

2017-02-14更新:
    1.增加通过实盘易对接实盘的代码，使策略可以直接实盘 Shipane类。
        实盘操作逻辑说明：
        核心思路是使实盘持仓尽量向模拟盘持仓靠拢。
        通过实盘持仓与模拟盘持仓的仓位对比，取得有差别的股票及数量。进行实盘下单。
        而不是根据策略买卖下单进行实盘下单的。
        (如需按策略下单去实盘下单，可以用实盘易官方SDK里的代码)
        关于实盘易的配置请上它的官网:http://www.iguuu.com/e
        该方法优缺点：
        优点：模拟盘与实盘持仓会相同或接近，有利于策略有效性检验，也使回测意义增大。
        缺点：在模拟盘与实盘资金差别比较大的时候，有可能会导致一些股票被频繁小部分的买卖。
              解决办法也有，就是模拟盘资金比实盘多时，买股前把可用资金先减去差额再去计算买股量。本策略暂时没加这部分
        Shipane规则默认未启用。如需要请配置好参数再开启
        注：代码未经严格实盘测试，请慎重使用！或用 通达信模拟炒股测试。
2017-1-11更新：
    1.策略组合选取配置那里，所有类 由 写类写字符串改为直接写类名
    2.Rule基类增加 on_get_obj_by_class_type外接函数。通过它实现一个规则得到另一个规则的实例
        方便某些情况下规则的相互调用。不再局限于只能handle_data顺序调用。本策略相对逻辑简单，没有使用。
    3.去除所有对象的__name__定义。更新代码时，直接用类的类型对比。
    4.为Rule添加memo属性，对象的memo直接以策略配置里的memo字段赋值，日志更直观
2017-1-5 更新
    1.修正不使用Query选股规则时报错的BUG
    2.修正28实时止损器 Stop_loss_by_28_index 的BUG
    3.Rule增加log_info和log_warn方法，增加显示是由哪个规则器输出的日志。
    4.把 tradestat也重构为规则类，集成到代码里。这样不用外部引用tradestat.py模块了
